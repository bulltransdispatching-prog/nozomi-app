<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nozomi Production</title>
    
    <!-- PWA Setup -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Nozomi">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .login-page {
            width: 100%;
            max-width: 400px;
        }
        
        .login-box {
            background: white;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .login-box .logo { font-size: 60px; margin-bottom: 10px; }
        .login-box h1 { color: #1e3c72; font-size: 22px; margin-bottom: 5px; }
        .login-box .subtitle { color: #666; font-size: 14px; margin-bottom: 25px; }
        
        .form-group { margin-bottom: 20px; text-align: left; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333;
            font-size: 14px;
        }
        .form-group label i { color: #667eea; margin-right: 8px; }
        
        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            transition: 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102,126,234,0.1);
        }
        
        .password-wrapper {
            position: relative;
        }
        
        .password-wrapper input {
            padding-right: 45px;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 16px;
        }
        
        .login-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            transition: 0.3s;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102,126,234,0.4);
        }
        
        .error-msg {
            background: #ffe6e6;
            color: #d63031;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }
        
        .error-msg.show { display: block; }
        
        .login-footer {
            margin-top: 25px;
            font-size: 12px;
            color: #999;
        }
        
        .login-footer i { margin-right: 5px; }
        
        .login-hint {
            margin-top: 20px;
            padding: 15px;
            background: #e8f4fd;
            border-radius: 10px;
            font-size: 12px;
            color: #1e3c72;
        }
        
        .login-hint strong { display: block; margin-bottom: 5px; }
        
        .app-page {
            display: none;
            width: 100%;
            max-width: 1400px;
        }
        
        .app-page.show { display: block; }
        
        .app-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .user-bar {
            background: linear-gradient(135deg, #2d3436, #636e72);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info { display: flex; align-items: center; gap: 12px; }
        
        .avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-size: 13px;
            transition: 0.3s;
        }
        
        .logout-btn:hover { background: rgba(255,255,255,0.2); }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header .logo { font-size: 50px; margin-bottom: 10px; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.9; font-size: 14px; }
        
        .status-bar {
            padding: 10px 20px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
        }
        
        .status-bar.online { background: #d4edda; color: #155724; }
        .status-bar.offline { background: #f8d7da; color: #721c24; }
        .status-bar.connecting { background: #fff3cd; color: #856404; }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: 0.3s;
        }
        
        .nav-tab:hover { background: #e9ecef; color: #667eea; }
        .nav-tab.active { background: white; color: #667eea; border-bottom: 3px solid #667eea; }
        .nav-tab i { margin-right: 8px; }
        
        .tab-content { display: none; padding: 25px; }
        .tab-content.active { display: block; }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .alert-success { background: #d4edda; color: #155724; }
        
        .form-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .form-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        
        .form-section input,
        .form-section select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Poppins', sans-serif;
        }
        
        .form-section input:focus,
        .form-section select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .machine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .machine-card {
            background: white;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 20px;
            transition: 0.3s;
            position: relative;
            overflow: visible;
        }
        
        .machine-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(102,126,234,0.15);
        }
        
        .machine-card h4 {
            color: #1e3c72;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .machine-card h4 i { color: #667eea; margin-right: 8px; }
        
        .product-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .product-row input,
        .product-row select {
            padding: 10px;
            border: 2px solid #e8e8e8;
            border-radius: 8px;
            font-size: 13px;
            font-family: 'Poppins', sans-serif;
        }
        
        .product-row select {
            position: relative;
            z-index: 5;
        }
        
        .add-btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .btn-group { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 20px; }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: 0.3s;
        }
        
        .btn-success { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #ff6b6b); color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #6dd5ed); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
        
        .report-controls {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .table-container {
            overflow-x: auto;
            border: 2px solid #667eea;
            border-radius: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .data-table th,
        .data-table td {
            border: 1px solid #dee2e6;
            padding: 10px 8px;
            text-align: center;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .data-table .date-cell { background: #e8eaf6; font-weight: 600; }
        .data-table .shift-cell { background: #f5f5f5; }
        .data-table .total-row { background: #ffd966; font-weight: 700; }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 25px;
            border-radius: 16px;
            text-align: center;
        }
        
        .summary-card:nth-child(2n) { background: linear-gradient(135deg, #f093fb, #f5576c); }
        .summary-card:nth-child(3n) { background: linear-gradient(135deg, #4facfe, #00f2fe); }
        
        .summary-card .icon { font-size: 32px; margin-bottom: 10px; }
        .summary-card h3 { font-size: 14px; margin-bottom: 10px; opacity: 0.9; }
        .summary-card .value { font-size: 24px; font-weight: 700; }
        
        .backup-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .backup-section h4 { margin-bottom: 15px; color: #1e3c72; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid #e8e8e8;
        }
        
        .stat-box .number { font-size: 28px; font-weight: 700; color: #667eea; }
        .stat-box .label { font-size: 12px; color: #666; margin-top: 5px; }
        
        .footer {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #dee2e6;
            font-size: 13px;
            color: #666;
        }
        
        .footer strong { color: #667eea; }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 9999;
            animation: slideIn 0.3s;
        }
        
        .toast.success { background: linear-gradient(135deg, #28a745, #20c997); }
        .toast.error { background: linear-gradient(135deg, #dc3545, #ff6b6b); }
        .toast.warning { background: #ffc107; color: #333; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            gap: 20px;
            z-index: 9999;
        }
        
        .loading.show { display: flex; }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading p { color: white; font-size: 16px; }
        
        .modal {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            max-width: 1100px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4);
        }
        
        .install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            display: none;
            align-items: center;
            gap: 15px;
            z-index: 99999;
            cursor: pointer;
        }
        
        .install-banner.show { display: flex; }
        
        .install-banner .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }
        
        @media (max-width: 768px) {
            .nav-tab span { display: none; }
            .nav-tab i { margin: 0; }
            .product-row { grid-template-columns: 1fr; }
            .btn-group { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .user-bar { flex-direction: column; gap: 10px; }
        }
        
        @media print {
            .user-bar, .status-bar, .nav-tabs, .btn-group, .report-controls, .alert, .add-btn, .login-page, .backup-section, .install-banner { display: none !important; }
            .app-page { display: block !important; }
            .tab-content { display: block !important; }
        }
    </style>
</head>
<body>
    <!-- LOADING -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>

    <!-- INSTALL BANNER -->
    <div class="install-banner" id="installBanner">
        <i class="fas fa-download"></i>
        <span>Install App</span>
        <button class="close-btn" onclick="event.stopPropagation(); document.getElementById('installBanner').classList.remove('show');">√ó</button>
    </div>

    <!-- LOGIN PAGE -->
    <div class="login-page" id="loginPage">
        <div class="login-box">
            <div class="logo">üè≠</div>
            <h1>NOZOMI AROMATIC</h1>
            <p class="subtitle">Production Management System</p>
            
            <div class="error-msg" id="errorMsg">
                <i class="fas fa-exclamation-circle"></i>
                <span id="errorText">Invalid username or password</span>
            </div>
            
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" placeholder="Enter username" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-lock"></i> Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="password" placeholder="Enter password" required autocomplete="current-password">
                        <button type="button" class="toggle-password" onclick="togglePassword()">
                            <i class="fas fa-eye" id="eyeIcon"></i>
                        </button>
                    </div>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
            </form>
            
            <div class="login-hint">
                <strong>üìå Login Credentials:</strong>
                Username: <b>admin</b> | Password: <b>admin123</b>
            </div>
            
            <div class="login-footer">
                <i class="fas fa-shield-alt"></i> Secure Login
                <span style="margin: 0 10px;">|</span>
                <i class="fas fa-cloud"></i> Cloud Connected
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div class="app-page" id="appPage">
        <div class="app-container">
            <!-- User Bar -->
            <div class="user-bar">
                <div class="user-info">
                    <div class="avatar" id="avatar">A</div>
                    <div>
                        <strong id="userName">Admin</strong>
                        <div style="font-size: 11px; opacity: 0.8;">
                            <i class="fas fa-clock"></i> <span id="loginTime">--</span>
                        </div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <!-- Status Bar -->
            <div class="status-bar connecting" id="statusBar">
                <i class="fas fa-cloud"></i> Connecting to database...
            </div>
            
            <!-- Header -->
            <div class="header">
                <div class="logo">üè≠</div>
                <h1>NOZOMI AROMATIC PVT. LTD.</h1>
                <p>Monthly Production Management System</p>
            </div>
            
            <!-- Navigation -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('entry')">
                    <i class="fas fa-edit"></i><span>Daily Entry</span>
                </button>
                <button class="nav-tab" onclick="showTab('report')">
                    <i class="fas fa-table"></i><span>Report</span>
                </button>
                <button class="nav-tab" onclick="showTab('summary')">
                    <i class="fas fa-chart-bar"></i><span>Summary</span>
                </button>
                <button class="nav-tab" onclick="showTab('backup')">
                    <i class="fas fa-database"></i><span>Backup</span>
                </button>
            </div>
            
            <!-- Tab: Daily Entry -->
            <div class="tab-content active" id="entry-tab">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Your data is automatically saved to cloud database.</span>
                </div>
                
                <div class="form-section">
                    <div class="form-row">
                        <div>
                            <label><i class="fas fa-calendar"></i> Date</label>
                            <input type="date" id="entryDate">
                        </div>
                        <div>
                            <label><i class="fas fa-clock"></i> Shift</label>
                            <select id="entryShift">
                                <option value="">Select Shift</option>
                                <option value="DAY SHIFT">‚òÄÔ∏è DAY SHIFT</option>
                                <option value="NIGHT SHIFT">üåô NIGHT SHIFT</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="machine-grid" id="machineGrid"></div>
                
                <div class="btn-group">
                    <button class="btn btn-success" onclick="saveEntry()" id="saveBtn">
                        <i class="fas fa-cloud-upload-alt"></i> Save to Cloud
                    </button>
                    <button class="btn btn-danger" onclick="clearForm()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            
            <!-- Tab: Report -->
            <div class="tab-content" id="report-tab">
                <div class="report-controls">
                    <div>
                        <label><i class="fas fa-calendar"></i> Month</label>
                        <input type="month" id="reportMonth" onchange="generateReport()">
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                    <button class="btn btn-info" onclick="printReport()">
                        <i class="fas fa-print"></i> Print
                    </button>
                    <button class="btn btn-success" onclick="exportExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                </div>
                
                <div class="table-container" id="reportContainer">
                    <p style="padding: 40px; text-align: center; color: #666;">Select a month to view report</p>
                </div>
            </div>
            
            <!-- Tab: Summary -->
            <div class="tab-content" id="summary-tab">
                <div class="report-controls">
                    <div>
                        <label><i class="fas fa-calendar"></i> Month</label>
                        <input type="month" id="summaryMonth" onchange="generateSummary()">
                    </div>
                    <button class="btn btn-primary" onclick="generateSummary()">
                        <i class="fas fa-sync"></i> Refresh
                    </button>
                </div>
                
                <div class="summary-cards" id="summaryCards">
                    <p style="padding: 40px; text-align: center; color: #666;">Select a month</p>
                </div>
            </div>
            
            <!-- Tab: Backup -->
            <div class="tab-content" id="backup-tab">
                <div class="alert alert-success">
                    <i class="fas fa-shield-alt"></i>
                    <span>Your data is safely stored in Firebase cloud.</span>
                </div>
                
                <div class="stats-grid" id="statsGrid"></div>
                
                <div class="backup-section">
                    <h4><i class="fas fa-download"></i> Download Backup</h4>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="downloadBackup()">
                            <i class="fas fa-download"></i> Download JSON
                        </button>
                        <button class="btn btn-success" onclick="exportAllExcel()">
                            <i class="fas fa-file-excel"></i> Export All Excel
                        </button>
                    </div>
                </div>
                
                <div class="backup-section">
                    <h4><i class="fas fa-upload"></i> Restore Backup</h4>
                    <input type="file" id="restoreFile" accept=".json" style="display:none" onchange="restoreBackup(event)">
                    <button class="btn btn-info" onclick="document.getElementById('restoreFile').click()">
                        <i class="fas fa-upload"></i> Upload Backup
                    </button>
                </div>
            </div>
            
            <!-- Footer -->
            <div class="footer">
                Developed by <strong>Nouman Shah Bodla</strong>
            </div>
        </div>
    </div>

    <!-- EDIT MODAL -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="font-size:18px; color:#1e3c72;"><i class="fas fa-edit"></i> Edit Entry</h3>
                <button class="btn btn-danger" style="padding:6px 10px; font-size:12px;" onclick="closeEditModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="editModalBody"></div>
            <div class="btn-group" style="margin-top:20px;">
                <button class="btn btn-success" onclick="saveEdit()"><i class="fas fa-save"></i> Save Changes</button>
                <button class="btn btn-secondary" onclick="closeEditModal()"><i class="fas fa-times"></i> Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase & XLSX -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCSZ3fvmpZff0hnBL4Zeq0a11IIIyOtrUQ",
            authDomain: "nozomi-production.firebaseapp.com",
            databaseURL: "https://nozomi-production-default-rtdb.firebaseio.com",
            projectId: "nozomi-production",
            storageBucket: "nozomi-production.firebasestorage.app",
            messagingSenderId: "795824130015",
            appId: "1:795824130015:web:e9485b5fa19ff459e8266a"
        };
        
        // =============================================
        // SIMPLE LOGIN CREDENTIALS
        // =============================================
        const USERS = {
            "admin":   { password: "admin123",   name: "Administrator" },
            "nouman":  { password: "nouman123",  name: "Nouman Shah Bodla" },
            "op1":     { password: "op1",        name: "Operator 1" },
            "op2":     { password: "op2",        name: "Operator 2" }
        };
        
        // MACHINES
        const MACHINES = [
            { name: 'INTERFOLD',    icon: 'fa-cogs' },
            { name: 'STACK',        icon: 'fa-boxes' },
            { name: 'TOILET ROLL',  icon: 'fa-toilet-paper' },
            { name: 'JUMBO ROLL',   icon: 'fa-circle-notch' },
            { name: 'HYGIENE OLD',  icon: 'fa-pump-soap' },
            { name: 'HYGIENE NEW',  icon: 'fa-pump-soap' },
            { name: 'TABLE NAPKIN', icon: 'fa-scroll' },
            { name: 'COFFEE NAPKIN',icon: 'fa-coffee' },
            { name: 'PAPER CUP',    icon: 'fa-glass-whiskey' }
        ];
        
        // GLOBALS
        let database, dataRef;
        let allData = {};
        let currentUser = null;
        let currentMonth = null;
        let currentEditKey = null;
        
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('nozomi_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showApp();
            }
        });
        
        // LOGIN FUNCTION
        function login(e) {
            e.preventDefault();
            const u = document.getElementById('username').value.trim().toLowerCase();
            const p = document.getElementById('password').value;
            const btn = document.getElementById('loginBtn');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
            
            setTimeout(() => {
                if (USERS[u] && USERS[u].password === p) {
                    currentUser = { 
                        username: u, 
                        name: USERS[u].name, 
                        loginTime: new Date().toLocaleString() 
                    };
                    localStorage.setItem('nozomi_user', JSON.stringify(currentUser));
                    hideError();
                    showApp();
                    toast('Welcome, ' + currentUser.name + '!', 'success');
                } else {
                    showError('Invalid username or password!');
                }
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
            }, 500);
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('nozomi_user');
                location.reload();
            }
        }
        
        function showError(msg) {
            document.getElementById('errorText').textContent = msg;
            document.getElementById('errorMsg').classList.add('show');
        }
        
        function hideError() {
            document.getElementById('errorMsg').classList.remove('show');
        }
        
        function togglePassword() {
            const pwd = document.getElementById('password');
            const icon = document.getElementById('eyeIcon');
            if (pwd.type === 'password') {
                pwd.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                pwd.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }
        
        function showApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appPage').classList.add('show');
            document.body.style.display = 'block';
            document.body.style.padding = '20px';
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            document.getElementById('loginTime').textContent = currentUser.loginTime;
            initApp();
        }
        
        function initApp() {
            document.getElementById('entryDate').valueAsDate = new Date();
            const m = new Date().toISOString().slice(0,7);
            document.getElementById('reportMonth').value = m;
            document.getElementById('summaryMonth').value = m;
            buildMachines();
            initFirebase();
        }
        
        function initFirebase() {
            showLoading('Connecting to Firebase...');
            try {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                dataRef = database.ref('productionData');
                dataRef.on('value', snap => {
                    allData = snap.val() || {};
                    hideLoading();
                    updateStats();
                    setStatus('online', '‚úÖ Connected to Firebase');
                }, err => {
                    hideLoading();
                    setStatus('offline', '‚ùå Connection error');
                    console.error(err);
                });
                database.ref('.info/connected').on('value', s => {
                    if (s.val()) setStatus('online', '‚úÖ Connected to Firebase');
                    else setStatus('offline', '‚ùå Offline - Trying to reconnect');
                });
            } catch (e) {
                hideLoading();
                setStatus('offline', '‚ùå Firebase error');
                console.error(e);
            }
        }
        
        function setStatus(type, text) {
            const bar = document.getElementById('statusBar');
            bar.className = 'status-bar ' + type;
            bar.innerHTML = '<i class="fas fa-cloud"></i> ' + text;
        }
        
        function buildMachines() {
            const grid = document.getElementById('machineGrid');
            grid.innerHTML = MACHINES.map(m => `
                <div class="machine-card">
                    <h4><i class="fas ${m.icon}"></i> ${m.name}</h4>
                    <div class="products" data-machine="${m.name}">
                        <div class="product-row">
                            <input type="text" placeholder="Product" class="pname">
                            <input type="number" placeholder="Qty" class="pqty" min="0">
                            <select class="puom">
                                <option>PCS</option><option>CTNS</option><option>BOX</option><option>PKTS</option>
                            </select>
                        </div>
                    </div>
                    <button class="add-btn" onclick="addRow(this)"><i class="fas fa-plus"></i> Add</button>
                </div>
            `).join('');
        }
        
        function addRow(btn) {
            const c = btn.previousElementSibling;
            const row = document.createElement('div');
            row.className = 'product-row';
            row.innerHTML = `
                <input type="text" placeholder="Product" class="pname">
                <input type="number" placeholder="Qty" class="pqty" min="0">
                <select class="puom">
                    <option>PCS</option><option>CTNS</option><option>BOX</option><option>PKTS</option>
                </select>`;
            c.appendChild(row);
        }
        
        async function saveEntry() {
            const date = document.getElementById('entryDate').value;
            const shift = document.getElementById('entryShift').value;
            if (!date || !shift) { toast('Please select date and shift!', 'warning'); return; }
            
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            
            const newPart = {
                date,
                shift,
                machines: {},
                savedBy: currentUser ? currentUser.name : 'Unknown',
                timestamp: Date.now()
            };
            
            document.querySelectorAll('.products').forEach(container => {
                const machine = container.dataset.machine;
                const products = [];
                container.querySelectorAll('.product-row').forEach(row => {
                    const name = row.querySelector('.pname').value.trim();
                    const qty  = row.querySelector('.pqty').value;
                    const uom  = row.querySelector('.puom').value;
                    if (name && qty) products.push({ product: name, quantity: parseInt(qty), uom });
                });
                if (products.length) newPart.machines[machine] = products;
            });
            
            if (!Object.keys(newPart.machines).length) {
                toast('Enter at least one product!', 'warning');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
                return;
            }
            
            const key = `${date}_${shift}`.replace(/[.#$[\]]/g, '-');
            
            try {
                let finalEntry;
                const existing = allData[key];
                if (existing) {
                    finalEntry = JSON.parse(JSON.stringify(existing));
                    finalEntry.date      = date;
                    finalEntry.shift     = shift;
                    finalEntry.savedBy   = newPart.savedBy;
                    finalEntry.timestamp = newPart.timestamp;
                    if (!finalEntry.machines) finalEntry.machines = {};
                    Object.entries(newPart.machines).forEach(([machine, products]) => {
                        finalEntry.machines[machine] = products;
                    });
                } else {
                    finalEntry = newPart;
                }
                
                await dataRef.child(key).set(finalEntry);
                allData[key] = finalEntry;
                toast('‚úÖ Saved successfully!', 'success');
                clearForm();
            } catch (e) {
                console.error(e);
                toast('‚ùå Error saving!', 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Save to Cloud';
        }
        
        function clearForm() {
            document.querySelectorAll('.pname, .pqty').forEach(i => i.value = '');
            document.querySelectorAll('.products').forEach(c => {
                const rows = c.querySelectorAll('.product-row');
                for (let i = rows.length - 1; i > 0; i--) rows[i].remove();
            });
        }
        
        function showTab(name) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(name + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
            if (name === 'report') generateReport();
            if (name === 'summary') generateSummary();
            if (name === 'backup') updateStats();
        }
        
        function generateReport() {
            const month = document.getElementById('reportMonth').value;
            if (!month) return;
            currentMonth = month;
            const [year, mon] = month.split('-');
            const days = new Date(year, mon, 0).getDate();
            
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>DATE</th><th>SHIFT</th>';
            MACHINES.forEach(m => html += `<th colspan="3">${m.name}</th>`);
            html += '<th>ACTIONS</th></tr><tr><th></th><th></th>';
            MACHINES.forEach(() => html += '<th>Product</th><th>Qty</th><th>UOM</th>');
            html += '<th></th></tr></thead><tbody>';
            
            const totals = {}; MACHINES.forEach(m => totals[m.name] = {});
            let hasData=false;
            
            for (let d = 1; d <= days; d++) {
                const date = `${year}-${mon}-${String(d).padStart(2,'0')}`;
                ['DAY SHIFT','NIGHT SHIFT'].forEach(shift=>{
                    const key = `${date}_${shift}`.replace(/[.#$[\]]/g,'-');
                    const entry = allData[key];
                    if (entry && entry.machines) {
                        hasData=true;
                        let maxRows = 1;
                        Object.values(entry.machines).forEach(arr=>maxRows=Math.max(maxRows,arr.length));
                        for (let r=0;r<maxRows;r++) {
                            html += '<tr>';
                            if (r===0) {
                                html += `<td class="date-cell" rowspan="${maxRows}">${mon}/${d}</td>`;
                                html += `<td class="shift-cell" rowspan="${maxRows}">${shift}</td>`;
                            }
                            MACHINES.forEach(m=>{
                                const p = (entry.machines[m.name]||[])[r];
                                if (p) {
                                    html += `<td>${p.product}</td><td>${p.quantity}</td><td>${p.uom}</td>`;
                                    if(!totals[m.name][p.uom]) totals[m.name][p.uom]=0;
                                    totals[m.name][p.uom]+=p.quantity;
                                } else {
                                    html+='<td></td><td></td><td></td>';
                                }
                            });
                            if (r===0) {
                                html += `<td rowspan="${maxRows}">
                                    <button class="btn btn-primary" style="padding:6px 10px; font-size:11px; margin-bottom:4px;" onclick="openEditModal('${key}')">
                                        <i class="fas fa-pen"></i> Edit
                                    </button>
                                    <button class="btn btn-danger" style="padding:6px 10px; font-size:11px;" onclick="deleteEntry('${key}')">
                                        <i class="fas fa-trash"></i> Delete
                                    </button>
                                </td>`;
                            }
                            html += '</tr>';
                        }
                    }
                });
            }
            
            html += '<tr class="total-row"><td colspan="2"><strong>TOTAL</strong></td>';
            MACHINES.forEach(m=>{
                const t = totals[m.name];
                const str = Object.entries(t).map(([u,q])=>`${q} ${u}`).join(' + ') || '0';
                html += `<td colspan="3"><strong>${str}</strong></td>`;
            });
            html += '<td></td></tr></tbody></table>';
            
            if (!hasData) {
                html = '<p style="padding:40px;text-align:center;color:#666;"><i class="fas fa-inbox" style="font-size:40px;display:block;margin-bottom:10px;"></i>No data for this month</p>';
            }
            document.getElementById('reportContainer').innerHTML = html;
        }
        
        function openEditModal(key) {
            const entry = allData[key];
            if (!entry) { toast('Entry not found', 'error'); return; }
            currentEditKey = key;
            
            let html = `
                <div class="form-section">
                    <div class="form-row">
                        <div>
                            <label>Date</label>
                            <input type="date" id="editDate" value="${entry.date}">
                        </div>
                        <div>
                            <label>Shift</label>
                            <select id="editShift">
                                <option value="DAY SHIFT" ${entry.shift==='DAY SHIFT'?'selected':''}>DAY SHIFT</option>
                                <option value="NIGHT SHIFT" ${entry.shift==='NIGHT SHIFT'?'selected':''}>NIGHT SHIFT</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="machine-grid" id="editMachines">
            `;
            
            MACHINES.forEach(m => {
                const prods = (entry.machines && entry.machines[m.name]) || [];
                html += `
                    <div class="machine-card">
                        <h4><i class="fas ${m.icon}"></i> ${m.name}</h4>
                        <div class="products" data-machine="${m.name}">
                `;
                if (prods.length) {
                    prods.forEach(p => {
                        html += `
                            <div class="product-row">
                                <input type="text" class="pname" placeholder="Product" value="${p.product}">
                                <input type="number" class="pqty" placeholder="Qty" min="0" value="${p.quantity}">
                                <select class="puom">
                                    <option ${p.uom==='PCS'?'selected':''}>PCS</option>
                                    <option ${p.uom==='CTNS'?'selected':''}>CTNS</option>
                                    <option ${p.uom==='BOX'?'selected':''}>BOX</option>
                                    <option ${p.uom==='PKTS'?'selected':''}>PKTS</option>
                                </select>
                            </div>
                        `;
                    });
                } else {
                    html += `
                        <div class="product-row">
                            <input type="text" class="pname" placeholder="Product">
                            <input type="number" class="pqty" placeholder="Qty" min="0">
                            <select class="puom">
                                <option>PCS</option><option>CTNS</option><option>BOX</option><option>PKTS</option>
                            </select>
                        </div>
                    `;
                }
                html += `
                        </div>
                        <button class="add-btn" onclick="addRow(this)"><i class="fas fa-plus"></i> Add</button>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('editModalBody').innerHTML = html;
            document.getElementById('editModal').classList.add('show');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
            currentEditKey = null;
        }
        
        async function saveEdit() {
            if (!currentEditKey) return;
            const date = document.getElementById('editDate').value;
            const shift = document.getElementById('editShift').value;
            if (!date || !shift) { toast('Date & shift required', 'warning'); return; }
            
            const entry = {
                date,
                shift,
                machines: {},
                savedBy: currentUser ? currentUser.name : 'Unknown',
                timestamp: Date.now()
            };
            
            document.querySelectorAll('#editMachines .products').forEach(container => {
                const machine = container.dataset.machine;
                const products = [];
                container.querySelectorAll('.product-row').forEach(row => {
                    const name = row.querySelector('.pname').value.trim();
                    const qty  = row.querySelector('.pqty').value;
                    const uom  = row.querySelector('.puom').value;
                    if (name && qty) products.push({ product: name, quantity: parseInt(qty), uom });
                });
                if (products.length) entry.machines[machine] = products;
            });
            
            const newKey = `${date}_${shift}`.replace(/[.#$[\]]/g, '-');
            try {
                if (currentEditKey !== newKey) {
                    await dataRef.child(currentEditKey).remove();
                    delete allData[currentEditKey];
                }
                await dataRef.child(newKey).set(entry);
                allData[newKey] = entry;
                toast('‚úÖ Changes saved!', 'success');
                closeEditModal();
                generateReport();
                updateStats();
            } catch (e) {
                console.error(e);
                toast('‚ùå Error saving changes', 'error');
            }
        }
        
        async function deleteEntry(key) {
            if (!confirm('Delete this entry?')) return;
            try {
                await dataRef.child(key).remove();
                delete allData[key];
                toast('‚úÖ Entry deleted', 'success');
                generateReport();
                updateStats();
            } catch (e) {
                console.error(e);
                toast('‚ùå Error deleting entry', 'error');
            }
        }
        
        function generateSummary() {
            const month = document.getElementById('summaryMonth').value;
            if (!month) return;
            const totals = {}; MACHINES.forEach(m=>totals[m.name]={});
            Object.values(allData).forEach(entry=>{
                if(entry.date && entry.date.startsWith(month) && entry.machines){
                    Object.entries(entry.machines).forEach(([machine,products])=>{
                        products.forEach(p=>{
                            if(!totals[machine][p.uom]) totals[machine][p.uom]=0;
                            totals[machine][p.uom]+=p.quantity;
                        });
                    });
                }
            });
            document.getElementById('summaryCards').innerHTML=MACHINES.map(m=>{
                const t=totals[m.name]||{};
                const str=Object.entries(t).map(([u,q])=>`${q} ${u}`).join(' + ')||'0';
                return `<div class="summary-card"><div class="icon"><i class="fas ${m.icon}"></i></div><h3>${m.name}</h3><div class="value">${str}</div></div>`;
            }).join('');
        }
        
        function updateStats() {
            const entries=Object.keys(allData).length;
            let products=0; const months=new Set();
            Object.values(allData).forEach(entry=>{
                if(entry.date) months.add(entry.date.slice(0,7));
                if(entry.machines) Object.values(entry.machines).forEach(p=>products+=p.length);
            });
            document.getElementById('statsGrid').innerHTML=`
                <div class="stat-box"><div class="number">${entries}</div><div class="label">Entries</div></div>
                <div class="stat-box"><div class="number">${products}</div><div class="label">Products</div></div>
                <div class="stat-box"><div class="number">${months.size}</div><div class="label">Months</div></div>
                <div class="stat-box"><div class="number">‚úì</div><div class="label">Synced</div></div>`;
        }
        
        function downloadBackup() {
            const blob=new Blob([JSON.stringify(allData,null,2)],{type:'application/json'});
            const a=document.createElement('a');
            a.href=URL.createObjectURL(blob);
            a.download=`nozomi_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            toast('‚úÖ Backup downloaded!','success');
        }
        
        function exportExcel() {
            if(!currentMonth){toast('Select month first!','warning');return;}
            const [year,mon]=currentMonth.split('-');
            const days=new Date(year,mon,0).getDate();
            const data=[['DATE','SHIFT',...MACHINES.flatMap(m=>[m.name+' Product',m.name+' Qty',m.name+' UOM'])]];
            for(let d=1;d<=days;d++){
                const date=`${year}-${mon}-${String(d).padStart(2,'0')}`;
                ['DAY SHIFT','NIGHT SHIFT'].forEach(shift=>{
                    const key=`${date}_${shift}`.replace(/[.#$[\]]/g,'-');
                    const entry=allData[key];
                    if(entry && entry.machines){
                        let rows=1;
                        Object.values(entry.machines).forEach(a=>rows=Math.max(rows,a.length));
                        for(let r=0;r<rows;r++){
                            const row=[r===0?date:'',r===0?shift:''];
                            MACHINES.forEach(m=>{
                                const p=(entry.machines[m.name]||[])[r];
                                row.push(p?p.product:'',p?p.quantity:'',p?p.uom:'');
                            });
                            data.push(row);
                        }
                    }
                });
            }
            const ws=XLSX.utils.aoa_to_sheet(data);
            const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'Report');
            XLSX.writeFile(wb,`Nozomi_${currentMonth}.xlsx`);
            toast('‚úÖ Excel exported!','success');
        }
        
        function exportAllExcel() {
            const data=[['DATE','SHIFT',...MACHINES.flatMap(m=>[m.name+' Product',m.name+' Qty',m.name+' UOM'])]];
            Object.values(allData).sort((a,b)=>a.date.localeCompare(b.date)).forEach(entry=>{
                if(entry.machines){
                    let rows=1;
                    Object.values(entry.machines).forEach(a=>rows=Math.max(rows,a.length));
                    for(let r=0;r<rows;r++){
                        const row=[r===0?entry.date:'',r===0?entry.shift:''];
                        MACHINES.forEach(m=>{
                            const p=(entry.machines[m.name]||[])[r];
                            row.push(p?p.product:'',p?p.quantity:'',p?p.uom:'');
                        });
                        data.push(row);
                    }
                }
            });
            const ws=XLSX.utils.aoa_to_sheet(data);
            const wb=XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb,ws,'All Data');
            XLSX.writeFile(wb,'Nozomi_All_Data.xlsx');
            toast('‚úÖ All data exported!','success');
        }
        
        async function restoreBackup(e) {
            const file=e.target.files[0];
            if(!file)return;
            if(!confirm('This will merge with existing data. Continue?')){e.target.value='';return;}
            showLoading('Restoring...');
            const reader=new FileReader();
            reader.onload=async(ev)=>{
                try{
                    const data=JSON.parse(ev.target.result);
                    for(const [key,val] of Object.entries(data)){
                        await dataRef.child(key).set(val);
                    }
                    hideLoading();
                    toast('‚úÖ Backup restored!','success');
                }catch(err){
                    hideLoading();
                    toast('‚ùå Invalid file!','error');
                }
            };
            reader.readAsText(file);
            e.target.value='';
        }
        
        function printReport() {
            if(!currentMonth){toast('Select month first!','warning');return;}
            window.print();
        }
        
        function showLoading(text){
            document.getElementById('loadingText').textContent=text||'Loading...';
            document.getElementById('loading').classList.add('show');
        }
        
        function hideLoading(){
            document.getElementById('loading').classList.remove('show');
        }
        
        function toast(msg,type){
            const t=document.createElement('div');
            t.className='toast '+type;
            t.textContent=msg;
            document.body.appendChild(t);
            setTimeout(()=>{
                t.style.opacity='0';
                t.style.transition='opacity 0.3s';
                setTimeout(()=>t.remove(),300);
            },3000);
        }
        
        // PWA SERVICE WORKER
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('sw.js')
                    .then(function(registration) {
                        console.log('PWA: ServiceWorker registered');
                    })
                    .catch(function(error) {
                        console.log('PWA: ServiceWorker failed', error);
                    });
            });
        }
        
        // PWA INSTALL PROMPT
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            setTimeout(() => {
                if (deferredPrompt) {
                    document.getElementById('installBanner').classList.add('show');
                }
            }, 3000);
        });
        
        document.getElementById('installBanner').addEventListener('click', async function() {
            if (!deferredPrompt) return;
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
            this.classList.remove('show');
        });
    </script>
</body>
</html>
